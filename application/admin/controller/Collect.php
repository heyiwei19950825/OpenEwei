<?php

namespace app\admin\controller;

use org\Helper;
use QL\QueryList;
use think\Controller;
use think\Db;
use think\Exception;
use think\Request;

class Collect extends Controller
{
    public $config;

    public function initialize()
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->config = model('admin/Config');
    }

    /**
     * 显示资源列表
     *
     * @return \think\Response
     */
    public function index()
    {
        return $this->fetch();
    }

    /**
     * 抓取规则
     */
    public function rule(){
        if($this->request->isPost()){
            ini_set('max_execution_time', '0');
            //初始化数据
            $params = $this->request->param();
            $url = $range = $dow_img = $code = $need_login = $login_url = $login_name = $login_password = $need_detail = $rule = $table_name = $get_model = $page = $detail_code = '';
            $list_name = $list_rule = $list_type = $list_desc = $detail_name = $detail_rule = $detail_type = $detail_desc = $table_collect_name = $table_field_name =  $second_filtration = $second = $row = $list_filtration = $detail_filtration = $urlArrKey = [];
            extract($params);

            $domain = 'http://'.explode('/',$params['url'])[2];//获取域名
            $key[]  = ['type'  => 'checkbox','fixed' => 'left',];
            $i      = 1;//默认页面数

            //是否需要模拟登陆
            if($need_login){
            }

            //判断抓取模式
            if( $get_model ===  "0" ){      //普通模式
                $rule = [];

                //需要做数据转换
                foreach ($list_name as $k => $v){

                    if( empty( $v ) || empty( $list_rule[$k] )  || empty( $list_type[$k] ) || empty( $list_desc[$k] ) ){
                        $this->error('列表规则参数不能为空');
                    }

                    $rule[$v] = [$list_rule[$k],$list_type[$k],$list_desc[$k]];
                }


                //设置详情规则
                if( $need_detail == 1 ){
                    foreach ($detail_name as $detailK => $detailV){
                        if( empty( $detailV ) || empty( $detail_rule[$detailK] )  || empty( $detail_type[$detailK] ) || empty( $detail_desc[$detailK] ) ){
                            $this->error('列表规则参数不能为空');
                        }
                        $detail_rules[$detailV] = [$detail_rule[$detailK],$detail_type[$detailK],$detail_desc[$detailK]];
                    }
                    $rule[$detail_code][] = $detail_rules;
                }

            }else{
                //数据验证
                try{
                    $rule = json_decode($params['rule'],true);
                    $list_filtration = [];
                    $detail_filtration = [];
                }catch (Exception $e){
                    $this->error('规则格式错误');
                }
            }

            //获取url类型的字段
            foreach ($rule as $k=>$v){
                if($v[2] == 'href'){
                    $urlArrKey[] = $k;
                }
            }

            if(empty($rule)) $this->error('列表规则参数不能为空或错误');

            //初始化话规则
            $ii = 0;
            foreach ($rule as $k => &$v){
                $key[] = [
                    'field'  => $k,
                    'title' => $v[2]
                ];


                //获取二级规则
                if(isset($v[3]) && !empty($v[3]) ){

                    if( $get_model ===  "1" ){
                        $detail_code = $k;
                    }

                    $second = $v[3];
                    //获取二级的正则规则
                    foreach ($second as $sK=>&$sV){
                        $key[] = [
                            'field'  => $sK,
                            'title'  => $sV[2]
                        ];
                        if( $get_model == "1" && isset($sV[4])) $detail_filtration[] = $sV[4];
                        unset($sV[2]);
                        unset($sV[3]);
                        unset($sV[4]);
                    }
                }

                //专业模式 提取 正则表达式
                if( isset($v[4])&&!empty($v[4]) ){
                    $list_filtration[$ii] = $v[4];
                }
                unset($v[3]);
                unset($v[4]);
            }

            //固定json返回key
            $key[] =["fixed"=> 'right', "width"=> 165, "align"=> 'center', "toolbar"=> '#barDemo'];
            //查询1级
            while ( $i <= $page ){
                // 待采集的页面地址
                $url = str_replace('@@',$i,$url);
                $headers = get_headers( $url );

                if (strpos($headers[0], '404'))
                {
                    continue;
                }

                // 切片选择器
                try{
                    $data = QueryList::Query($url,$rule,$range)->data;
                    foreach ($data as $dataK=>&$dataV){
                        $fi = 0;
                        $notNullVal = false;
                        foreach ($dataV as $fk => &$fv){
                            //验证数组中的值是否都为空
                            if(!empty($fv)){
                                $notNullVal = true;
                            }
                            //url判断[url添加域名]
                            if( in_array( $fk,$urlArrKey ) && !empty($fv) && !strstr('http',$fv ) ){
                                $fv = $domain.$fv;
                            }
                            //正则过滤
                            if( !empty($fv) &&  isset($list_filtration[$fi]) &&  $list_filtration[$fi]){
                                //拆分正则选取key标示
                                if( strpos($list_filtration[$fi],'@@@') ){
                                    $dFiltration = explode('@@@',$list_filtration[$fi]);
                                    $fKey = $dFiltration[1];
                                    $pregRule = $dFiltration[0];

                                }else{
                                    $pregRule = $list_filtration[$fi];
                                    $fKey = 1;
                                }
                                preg_match( $pregRule,$fv,$match);
                                if(!empty($match)){
                                    $fv = $match[$fKey];
                                }else{
                                    $fv = '暂无数据';
                                }
                            }
                            $fi++;
                        }
                        //数组值都为空则删除当前数组
                        if(!$notNullVal){
                            unset($data[$dataK]);
                        }
                    }
                }catch (Exception $e){
                    return $this->error('采集规则错误，请检查');
                }

                $row = array_merge($row, $data);
                $i++;
            }
            //查询2级
            if( !empty($second) ){
                //分解1级查询数据   [单线程]
                foreach ( $row as $rowKey => &$val) {
                    if($rowKey >1){
                        break;
                    }
                    //将url中的中文转换成编码【中文url 插件无法解析】
                    $secondUrl = Helper::chineseUrlToUrlCode( $val[$detail_code] );
                    //判断404页面
                    if(empty($secondUrl))continue 1;
                    $headers = get_headers( $secondUrl );
                    if (strpos($headers[0], '404'))
                    {
                        continue 1;
                    }

                    //判断是否是url
                    if( filter_var($secondUrl,FILTER_VALIDATE_URL) ){
                        $secondData = QueryList::Query($secondUrl,$second)->data;
                        //遍历查询结果  正则内容
                        foreach ($secondData as $sDataK=>&$sDataV){
                            $fi = 0;
                            foreach ($sDataV as $sFk => &$sFv){
                                //url判断[url添加域名]
                                if( in_array( $sFk,$urlArrKey ) && !empty($sFv) && !strstr('http',$sFv ) ){
                                    $sFv = $domain.$sFv;
                                }

                                //正则过滤
                                if( !empty($sFv) &&  isset($detail_filtration[$fi]) &&  $detail_filtration[$fi]){
                                    $sFv = str_replace('"','\'',$sFv);
                                    //拆分正则选取key标示
                                    if( strpos($detail_filtration[$fi],'@@@') ){
                                        $dFiltration = explode('@@@',$detail_filtration[$fi]);
                                        $fKey = $dFiltration[1];
                                        $pregRule = $dFiltration[0];
                                    }else{
                                        $pregRule = $detail_filtration[$fi];
                                        $fKey = 1;
                                    }
//                                    echo $pregRule;
//                                    echo $sFv;
                                    preg_match( $pregRule,$sFv,$match);
//                                    dump($match);die;
                                    if(!empty($match)){
                                        $sFv = $match[$fKey];
                                    }else{
                                        $sFv = '暂无数据';
                                    }
                                }
                                $fi++;
                            }
                        }
                        //二级内容合并
                        if( $secondData ){
                            $val = array_merge($val,$secondData[0]);
                        }
                    }
                }
            }
            return $this->success('查询成功','', ['key'=>$key,'data'=>$row]);
        }

        return $this->fetch();
    }

    /**
     * 保存抓取规则
     */
    public function saveRule(){

    }

    /**
     * 保存数据
     */
    public function saveData(){

        if( $this->request->isPost() ){
            $params  = $this->request->param();
            $params['data']    = json_decode($params['data'],true);
            parse_str($params['config'],$config);

            //独立数据转换
            if($params['alone'] == true){
                $data = $params['data'];
            }else{
                $data = $params['data'];
            }


            if(empty($data) ){
                return $this->error('暂无数据');
            }

            //检测表是否存在
            $checkRow = Db::query('show tables like "oc_'.$config['tableName'].'"');

            //表不存在并且不创建新表 提示错误
            if( empty($checkRow) ){

                return $this->error('数据表不存在');
            }
            try{
                //创建表
                if( $config['field'] != 0 ){
                    $field = array_keys($data[0]);
                    $tableField = Db::query('desc oc_'.$config['tableName']);
                    $tableFields = [];
                    foreach($tableField as $k=>$v){
                        $tableFields[] = $v['Field'];
                    }
                    $sql = '';
                    //检测字段是否已经存在表中   如果没有则生成sql语句              //生成sql语句
                    foreach ($field as $k=>$v){
                        if(!in_array($v,$tableFields)){
                            $len = ''; // 字段类型
                            $demo  = $data[0][$v];

                            $coutLen = strlen( $demo );

                            switch ($coutLen){
                                case $coutLen < 50:
                                    $len ='varchar(50)';
                                    break;

                                case $coutLen < 255:
                                    $len ='varchar(255)';
                                    break;

                                case $coutLen > 255:
                                    $len ='text';
                                    break;
                                default:
                                    $len ='text';
                                    break;
                            }
                            $sql .= ' ADD COLUMN `'.$v.'` '.$len.' DEFAULT NULL COMMENT \'测试\', ';
                        }

                    }
                    //执行sql语句
                    $sql = 'ALTER TABLE `oc_'.$config['tableName'].'`'.rtrim($sql,', ').';';
                    Db::query($sql);
                }
                //院校库===============================
                $names = Db::name($config['tableName'])->field('name')->select();

                foreach ($names as $aa=>$bb){
                    $names[$aa] = $bb['name'];
                }
                foreach ($data as $a => $b){
                    if(in_array($b['name'],$names)){
                            unset($data[$a]);
                    }
                }
                //院校库===============================
                $insertRow = true;
                //数据写入表中
                foreach ($data as $k=>$v){
                    $rows= Db::name($config['tableName'])->insert($v);
                    if(!$rows) $insertRow = false;
                }
                if($insertRow){
                    return $this->success('写入成功');
                }

            }catch (Exception $e){
                echo $e->getMessage();die;
                return $this->error('错误数据，请检查2');

            }
        }
    }

    /**
     * 采集入库配置
     * @return mixed
     */
    public function importConfig(){
        return $this->fetch();
    }



}
